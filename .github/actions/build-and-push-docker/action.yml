name: Build and Push Docker Image
description: |
  Unified Docker build and push action for both GHCR registries.

  Supports:
  - GHCR builds for community self-hosting
  - Automatic version resolution and tagging
  - Conditional signing and deployment tags

inputs:
  registry_type:
    description: "Registry type: 'ghcr'"
    default: "ghcr"

  # Version input
  version:
    description: "Explicit version (SemVer only, e.g., 1.2.3). If provided, this version is used directly. If empty, version is auto-generated from branch name."
    required: false
  experimental_mode:
    description: "Enable experimental timestamped versions"
    required: false
    default: "false"

  # GHCR specific inputs
  ghcr_image_name:
    description: "GHCR image name (required for GHCR builds)"
    required: false

  # Deployment options
  deploy_production:
    description: "Tag image for production deployment"
    required: false
    default: "false"
  deploy_staging:
    description: "Tag image for staging deployment"
    required: false
    default: "false"
  is_prerelease:
    description: "Whether this is a prerelease (auto-tags for staging/production)"
    required: false
    default: "false"
  make_latest:
    description: "Whether to tag as latest/production (from GitHub release 'Set as the latest release' option)"
    required: false
    default: "false"

  # Build options
  dockerfile:
    description: "Path to Dockerfile"
    required: false
    default: "Dockerfile"
  context:
    description: "Build context"
    required: false
    default: "."

outputs:
  image_tag:
    description: "Resolved image tag used for the build"
    value: ${{ steps.version.outputs.version }}
  registry_tags:
    description: "Complete registry tags that were pushed"
    value: ${{ steps.build.outputs.tags }}
  image_digest:
    description: "Image digest from the build"
    value: ${{ steps.build.outputs.digest }}

runs:
  using: "composite"
  steps:
    - name: Validate inputs
      shell: bash
      env:
        REGISTRY_TYPE: ${{ inputs.registry_type }}
        GHCR_IMAGE_NAME: ${{ inputs.ghcr_image_name }}
      run: |
        set -euo pipefail

        if [[ -z "$GHCR_IMAGE_NAME" ]]; then
          echo "ERROR: GHCR builds require ghcr_image_name"
          exit 1
        fi

        echo "SUCCESS: Input validation passed for $REGISTRY_TYPE build"

    - name: Resolve Docker version
      id: version
      uses: ./.github/actions/resolve-docker-version
      with:
        version: ${{ inputs.version }}
        current_branch: ${{ github.ref_name }}
        experimental_mode: ${{ inputs.experimental_mode }}

    - name: Set up Docker build tools
      uses: ./.github/actions/docker-build-setup
      with:
        registry: 'ghcr.io'
        setup_cosign: 'true'
        skip_login_on_pr: 'true'

    - name: Generate additional GHCR tags for releases
      if: ${{ inputs.experimental_mode == 'false' && (github.event_name == 'workflow_call' || github.event_name == 'release' || github.event_name == 'workflow_dispatch') }}
      id: ghcr-extra-tags
      shell: bash
      env:
        VERSION: ${{ steps.version.outputs.version }}
        IMAGE_NAME: ${{ inputs.ghcr_image_name }}
        IS_PRERELEASE: ${{ inputs.is_prerelease }}
        MAKE_LATEST: ${{ inputs.make_latest }}
      run: |
        set -euo pipefail

        # Start with base version tag
        TAGS="ghcr.io/${IMAGE_NAME}:${VERSION}"

        # For proper SemVer releases, add major.minor and major tags
        if [[ "${VERSION}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          # Extract major and minor versions
          MAJOR=$(echo "${VERSION}" | cut -d. -f1)
          MINOR=$(echo "${VERSION}" | cut -d. -f2)

          TAGS="${TAGS}\nghcr.io/${IMAGE_NAME}:${MAJOR}.${MINOR}"
          TAGS="${TAGS}\nghcr.io/${IMAGE_NAME}:${MAJOR}"

          echo "Added SemVer tags: ${MAJOR}.${MINOR}, ${MAJOR}"
        fi

        # Add latest tag for stable releases marked as latest
        if [[ "${IS_PRERELEASE}" == "false" && "${MAKE_LATEST}" == "true" ]]; then
          TAGS="${TAGS}\nghcr.io/${IMAGE_NAME}:latest"
          echo "Added latest tag for stable release marked as latest"
        fi

        echo "Generated GHCR tags:"
        echo -e "${TAGS}"

        # Debug: Show what will be passed to Docker build
        echo "DEBUG: Tags for Docker build step:"
        echo -e "${TAGS}"

        {
          echo "tags<<EOF"
          echo -e "${TAGS}"
          echo "EOF"
        } >> "${GITHUB_OUTPUT}"

    - name: Debug Docker build tags
      shell: bash
      run: |
        echo "=== DEBUG: Docker Build Configuration ==="
        echo "Registry Type: ${{ inputs.registry_type }}"
        echo "Experimental Mode: ${{ inputs.experimental_mode }}"
        echo "Event Name: ${{ github.event_name }}"
        echo "Is Prerelease: ${{ inputs.is_prerelease }}"
        echo "Make Latest: ${{ inputs.make_latest }}"
        echo "Version: ${{ steps.version.outputs.version }}"

        if [[ "${{ inputs.experimental_mode }}" == "true" ]]; then
          echo "GHCR Experimental Tags: ${{ steps.ghcr-meta-experimental.outputs.tags }}"
        else
          echo "GHCR Extra Tags: ${{ steps.ghcr-extra-tags.outputs.tags }}"
        fi

    - name: Build and push Docker image
      id: build
      uses: docker/build-push-action@v6
      with:
        context: ${{ inputs.context }}
        file: ${{ inputs.dockerfile }}
        platforms: linux/amd64 #,linux/arm64
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ (inputs.experimental_mode == 'true' && steps.ghcr-meta-experimental.outputs.tags) || (inputs.experimental_mode == 'false' && steps.ghcr-extra-tags.outputs.tags) || (format('ghcr.io/{0}:{1}', inputs.ghcr_image_name, steps.version.outputs.version)) }}
        labels: ${{ inputs.experimental_mode == 'true' && steps.ghcr-meta-experimental.outputs.labels || '' }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        provenance: mode=max
        sbom: true

    - name: Sign GHCR image (GHCR only)
      if: ${{ (github.event_name == 'workflow_call' || github.event_name == 'release' || github.event_name == 'workflow_dispatch') }}
      shell: bash
      env:
        TAGS: ${{ inputs.experimental_mode == 'true' && steps.ghcr-meta-experimental.outputs.tags || steps.ghcr-extra-tags.outputs.tags }}
        DIGEST: ${{ steps.build.outputs.digest }}
      run: |
        set -euo pipefail
        echo "${TAGS}" | xargs -I {} cosign sign --yes "{}@${DIGEST}"

    - name: Output build summary
      shell: bash
      env:
        REGISTRY_TYPE: ${{ inputs.registry_type }}
        IMAGE_TAG: ${{ steps.version.outputs.version }}
        VERSION_SOURCE: ${{ steps.version.outputs.source }}
      run: |
        echo "SUCCESS: Built and pushed Docker image to $REGISTRY_TYPE"
        echo "Image Tag: $IMAGE_TAG (source: $VERSION_SOURCE)"
        echo "GHCR Image: ghcr.io/${{ inputs.ghcr_image_name }}"
